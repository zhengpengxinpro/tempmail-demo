name: Deploy Backend to Server

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main/master åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® SSH å¯†é’¥
      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      # 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/tempmail' }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åç«¯æœåŠ¡..."
            echo "========================================="
            
            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd ${{ secrets.DEPLOY_PATH || '/opt/tempmail' }}
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main || git pull origin master
            
            # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
            if [ ! -f .env.production ]; then
              echo "âŒ é”™è¯¯ï¼š.env.production æ–‡ä»¶ä¸å­˜åœ¨ï¼"
              echo "è¯·å…ˆåˆ›å»ºå¹¶é…ç½® .env.production æ–‡ä»¶"
              exit 1
            fi
            
            # åœæ­¢æ—§æœåŠ¡
            echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
            docker-compose down || true
            
            # æ„å»ºæ–°é•œåƒ
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose build --no-cache
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            docker-compose --env-file .env.production up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
              if curl -f http://localhost:8080/health > /dev/null 2>&1; then
                echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
                docker-compose logs --tail=50 app
                exit 1
              fi
              echo "ç­‰å¾…ä¸­... ($i/30)"
              sleep 2
            done
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo "========================================="
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
            docker-compose ps
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ HTTP API: http://${{ secrets.SERVER_HOST }}:8080"
            echo "ğŸ“§ SMTP: ${{ secrets.SERVER_HOST }}:25"
            echo "========================================="
          ENDSSH
      
      # 4. éƒ¨ç½²ç»“æœé€šçŸ¥
      - name: Deployment Status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "æœåŠ¡åœ°å€: http://${{ secrets.SERVER_HOST }}:8080"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi
      
      # 5. æ¸…ç† SSH å¯†é’¥
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
