# 临时邮箱系统 - 产品设计文档 (PRD)

## 1. 项目概述

### 1.1 产品定位
临时邮箱是一个为用户提供一次性、临时邮箱地址的 SaaS 平台，用于注册网站、接收验证邮件，保护用户隐私，避免垃圾邮件骚扰。

### 1.2 目标用户
- **个人用户**：需要临时邮箱注册网站、接收验证码
- **开发者**：需要通过 API 集成临时邮箱功能到自己的应用
- **测试人员**：需要批量邮箱进行自动化测试

### 1.3 核心价值
- ✅ **隐私保护**：无需注册，邮件自动删除
- ✅ **即用即走**：随机生成，快速使用
- ✅ **开发者友好**：提供完整 REST API
- ✅ **多域名支持**：避免单一域名被屏蔽
- ✅ **实时推送**：30秒轮询 + WebSocket 双模式

---

## 2. 用户角色

### 2.1 游客 (Guest)
**特点**：无需注册，访问公共页面
**权限**：
- 生成临时邮箱（IP 限制：每天 3 个）
- 查看邮件（需要访问令牌）
- 邮件保留 24 小时

**典型场景**：
```
用户访问网站 → 点击"生成邮箱" → 获得临时邮箱地址
→ 使用邮箱注册其他网站 → 回到页面查看验证邮件
```

### 2.2 注册用户 (User)
**等级划分**：

| 等级 | 名称 | 邮箱数 | 邮件数/邮箱 | API限制(次/分钟) | 并发请求 | 自定义前缀 | 月费 |
|------|------|--------|-------------|-----------------|---------|-----------|------|
| Free | 免费版 | 3 | 30 | 30 | 5 | ❌ | $0 |
| Basic | 基础版 | 10 | 100 | 100 | 20 | ✅ | $9.99 |
| Pro | 专业版 | 50 | 500 | 500 | 50 | ✅ | $29.99 |
| Enterprise | 企业版 | 无限 | 无限 | 无限 | 100 | ✅ | $99.99 |

**权限**：
- 创建多个邮箱
- 自定义邮箱前缀
- 使用统计
- API 访问

### 2.3 开发者 (Developer)
**特点**：通过 API Key 调用接口
**权限**：
- 生成 API Key
- 编程方式管理邮箱
- Webhook 回调（可选）
- API 文档访问

### 2.4 管理员 (Admin)
**权限**：
- 域名管理（添加/删除/验证）
- 用户管理（查看/禁用/修改等级）
- 系统监控
- 审计日志查看

---

## 3. 核心功能模块

### 3.1 邮箱管理

#### 3.1.1 创建邮箱
**游客模式**：
- 点击"随机生成"按钮
- 系统生成随机邮箱地址（如：abc123@example.com）
- 返回邮箱地址 + 访问令牌
- 生成分享链接（如：https://site.com/abc123@example.com?token=xxx）

**注册用户模式**：
- 支持"随机生成"和"自定义前缀"
- 选择域名
- 设置过期时间（默认 24 小时）
- 关联到用户账户

**业务规则**：
- 游客：每个 IP 每天最多 3 个
- Free 用户：最多 3 个活跃邮箱
- Basic/Pro/Enterprise：按等级限制
- 邮箱地址全局唯一
- 支持的域名从配置中读取

#### 3.1.2 查看邮箱列表
**UI 展示**：
```
┌─────────────────────────────────────────────────┐
│ 我的邮箱                          [+ 创建邮箱]  │
├─────────────────────────────────────────────────┤
│ 邮箱地址              未读  总数  创建时间       │
├─────────────────────────────────────────────────┤
│ test@example.com      2     5    2024-01-01     │
│ custom@temp.mail      0     0    2024-01-02     │
└─────────────────────────────────────────────────┘
```

**功能**：
- 分页展示
- 按域名过滤
- 显示未读邮件数
- 快速操作（查看/删除）

#### 3.1.3 删除邮箱
- 单个删除
- 批量删除
- 自动清理：超过 24 小时自动删除

### 3.2 邮件接收与查看

#### 3.2.1 SMTP 接收
**技术流程**：
```
外部邮件服务器 → 我们的 SMTP 服务器(25/587端口)
→ 解析 MIME 邮件 → 存储到 Redis (TTL: 24h)
→ 发布 PubSub 事件 → WebSocket 推送给前端
```

**支持格式**：
- HTML 邮件
- 纯文本邮件
- Multipart 邮件
- 附件信息展示（暂不支持下载）

#### 3.2.2 邮件列表
**UI 展示**：
```
┌─────────────────────────────────────────────────┐
│ abc123@example.com                   [刷新] [🔔]│
├─────────────────────────────────────────────────┤
│ ● sender@gmail.com    Welcome!      刚刚        │
│   这是一封欢迎邮件...                            │
│                                                  │
│   reply@service.com   验证码        5分钟前     │
│   您的验证码是 123456                            │
└─────────────────────────────────────────────────┘
```

**功能**：
- 实时刷新（30秒轮询 + WebSocket）
- 未读标识
- 邮件预览
- 发件人/主题/时间
- 删除操作

#### 3.2.3 邮件详情
**展示内容**：
- 发件人（名称 + 邮箱）
- 收件人
- 主题
- 发送时间
- HTML 内容（使用 DOMPurify 清理，防 XSS）
- 纯文本内容（备用）
- 原始邮件头（可展开）
- 附件列表（仅展示信息）

**安全措施**：
- HTML 内容过滤（移除 script、iframe 等危险标签）
- 外部图片默认不加载（可选加载）
- 链接在新窗口打开

#### 3.2.4 实时推送
**主动模式（轮询）**：
- 每 30 秒自动刷新邮件列表
- 页面不可见时暂停轮询
- 新邮件到达时温和提示（Toast）

**被动模式（WebSocket）**：
- 建立 WebSocket 连接
- 监听 Redis PubSub 新邮件事件
- 实时推送新邮件通知
- 断线自动重连

### 3.3 域名管理（管理员）

#### 3.3.1 添加域名
**流程**：
```
管理员输入域名 → 生成 DNS 配置记录
→ 管理员在 DNS 服务商添加记录
→ 点击"验证配置" → 系统验证 MX/SPF 记录
→ 验证通过，域名激活
```

#### 3.3.2 DNS 配置生成
**自动生成以下记录**：
```
类型  主机记录         记录值                    优先级  TTL
MX    example.com     mail.yourserver.com       10      600
A     mail            your-server-ip            -       600
TXT   example.com     "v=spf1 mx ~all"          -       600
TXT   _dmarc          "v=DMARC1; p=none"        -       600
```

**功能**：
- 一键复制
- 导出文本
- 验证配置

#### 3.3.3 DNS 验证
**验证项**：
- ✅ MX 记录是否指向正确的邮件服务器
- ✅ SPF 记录是否配置
- ⚠️ DMARC 记录（可选）

**验证结果展示**：
```
✅ DNS 配置验证成功

MX 记录: ✅ 正确
SPF 记录: ✅ 正确
DMARC 记录: ⚠️ 未配置（可选）
```

#### 3.3.4 域名状态管理
**状态**：
- 🟢 启用中：DNS 已验证，正常接收邮件
- 🟡 待验证：DNS 未验证或验证失败
- 🔴 已禁用：管理员手动禁用
- 🟠 维护中：暂时停止接收

### 3.4 用户管理（管理员）

#### 3.4.1 用户列表
**展示信息**：
- 用户名 / 邮箱
- 当前等级
- 账户状态
- 邮箱数 / 配额
- 注册时间
- 最后登录

**操作**：
- 查看详情
- 修改等级
- 禁用/启用账户
- 查看使用统计

#### 3.4.2 等级管理
**配置项**：
- 等级名称
- 邮箱数量限制
- 每个邮箱邮件数限制
- API 调用限制（次/分钟、次/天）
- 并发请求限制
- 是否支持自定义邮箱
- 价格（月费/年费）

### 3.5 API 接口（开发者）

#### 3.5.1 API Key 管理
**用户端功能**：
- 生成 API Key
- 查看 API Key 列表
- 撤销 API Key
- 查看使用统计

**API Key 组成**：
- Key ID：`ak_xxxxx`（公开）
- Key Secret：`sk_yyyyy`（仅生成时显示一次）

#### 3.5.2 API 认证方式
**HMAC-SHA256 签名**：
```
Authorization: Bearer ak_xxxxx
X-Timestamp: 1234567890
X-Signature: abc123...

签名计算：
signature = HMAC-SHA256(
    secret=sk_yyyyy,
    message=timestamp + method + path + body
)
```

#### 3.5.3 API 接口列表
**邮箱管理**：
- `GET /api/v1/mailboxes` - 获取邮箱列表
- `POST /api/v1/mailboxes` - 创建邮箱
- `GET /api/v1/mailboxes/:email` - 获取邮箱详情
- `DELETE /api/v1/mailboxes/:email` - 删除邮箱

**邮件管理**：
- `GET /api/v1/mailboxes/:email/messages` - 获取邮件列表
- `GET /api/v1/messages/:id` - 获取邮件详情
- `DELETE /api/v1/messages/:id` - 删除邮件

**实时推送**：
- `WS /api/v1/mailboxes/:email/ws` - WebSocket 连接

**权限 Scopes**：
- `mailbox:read` - 读取邮箱
- `mailbox:write` - 创建/删除邮箱
- `mail:read` - 读取邮件
- `mail:write` - 删除邮件

### 3.6 统计分析

#### 3.6.1 用户端统计
**展示内容**：
- 今日配额使用情况
  - API 调用次数 / 限制
  - 创建邮箱数 / 限制
  - 接收邮件数
- 累计统计
  - 总邮箱数
  - 总邮件数
- 图表
  - 每日邮件接收趋势（7天）
  - 邮箱使用分布

#### 3.6.2 管理端统计
**系统概览**：
- 用户总数（今日新增）
- 邮箱总数（今日新增）
- 邮件总数（今日接收）
- 域名总数（活跃数）

**详细统计**：
- 邮件统计（图表）
  - 每日/每周/每月邮件数
  - 按域名统计
- 用户统计
  - 用户增长趋势
  - 等级分布
  - 活跃用户数
- 域名统计
  - 各域名邮件量
  - 域名健康状态

---

## 4. 用户体验设计

### 4.1 首页（公共端）

**布局**：
```
┌─────────────────────────────────────────────────┐
│            [Logo] 临时邮箱                       │
│                                                  │
│        保护您的隐私，告别垃圾邮件               │
│                                                  │
│    ┌────────────────────────────────────┐      │
│    │  [随机生成]  [自定义]               │      │
│    │                                     │      │
│    │  [example.com ▼]                    │      │
│    │                                     │      │
│    │  [生成邮箱]                          │      │
│    └────────────────────────────────────┘      │
│                                                  │
│  ✅ 无需注册  ✅ 1天自动删除  ✅ HTTPS加密      │
└─────────────────────────────────────────────────┘

特性介绍
使用指南
常见问题
```

### 4.2 用户端界面

**仪表盘**：
```
┌─────────────────────────────────────────────────┐
│ 概览                                             │
├─────────────────────────────────────────────────┤
│  邮箱总数    未读邮件    今日邮件    API调用    │
│     5          3          12         100       │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 快速操作                                         │
│  [+ 创建邮箱]  [查看统计]                        │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 最近邮件                                         │
│  • test@example.com - Welcome! (2分钟前)        │
│  • custom@temp.mail - 验证码 (5分钟前)           │
└─────────────────────────────────────────────────┘
```

**邮箱管理**：
- 左侧：邮箱列表（卡片/列表视图切换）
- 右侧：邮件列表 + 邮件详情（三栏布局）

### 4.3 管理端界面

**侧边栏导航**：
```
📊 系统概览
👥 用户管理
🌐 域名管理
📊 等级管理
📈 统计分析
📝 审计日志
⚙️ 系统设置
```

**域名管理页面**：
```
┌─────────────────────────────────────────────────┐
│ 域名管理                          [+ 添加域名]  │
├─────────────────────────────────────────────────┤
│ 域名              状态    邮箱数    今日邮件     │
├─────────────────────────────────────────────────┤
│ example.com      ✅启用   1000      500         │
│ [查看DNS] [验证] [禁用]                          │
│                                                  │
│ temp.mail        ⏳待验证  0         0          │
│ [查看DNS] [验证] [删除]                          │
└─────────────────────────────────────────────────┘
```

### 4.4 移动端适配

**响应式设计**：
- ✅ 桌面端（>1200px）：三栏布局
- ✅ 平板端（768-1200px）：两栏布局
- ✅ 手机端（<768px）：单栏布局，抽屉式导航

---

## 5. 业务流程

### 5.1 游客使用流程
```
用户访问首页
  ↓
点击"随机生成"
  ↓
系统生成临时邮箱（abc123@example.com）
  ↓
显示邮箱地址 + 访问令牌 + 分享链接
  ↓
用户复制邮箱地址，去其他网站注册
  ↓
回到页面（或通过分享链接访问）
  ↓
输入访问令牌（或 URL 已包含 token）
  ↓
查看邮件列表（实时刷新）
  ↓
点击邮件查看详情
  ↓
24小时后自动删除
```

### 5.2 注册用户使用流程
```
用户注册/登录
  ↓
进入仪表盘
  ↓
点击"创建邮箱"
  ↓
选择域名 + 自定义前缀（可选）
  ↓
邮箱创建成功，关联到账户
  ↓
在邮箱列表中查看所有邮箱
  ↓
选择邮箱查看邮件
  ↓
WebSocket 实时推送新邮件
  ↓
查看使用统计（配额/API调用）
```

### 5.3 开发者集成流程
```
注册用户并登录
  ↓
进入"API Key"管理页面
  ↓
点击"生成 API Key"
  ↓
设置名称 + 权限 Scopes
  ↓
获得 Key ID + Key Secret（仅显示一次）
  ↓
保存 Secret 到环境变量
  ↓
使用 SDK 或手动签名调用 API
  ↓
创建邮箱、查询邮件
  ↓
（可选）配置 Webhook 回调
```

### 5.4 管理员域名配置流程
```
管理员登录后台
  ↓
进入"域名管理"
  ↓
点击"添加域名"
  ↓
输入域名（example.com）
  ↓
系统生成 DNS 配置记录
  ↓
复制 DNS 记录（MX、A、TXT）
  ↓
在域名服务商添加 DNS 记录
  ↓
等待 DNS 生效（通常 10-30 分钟）
  ↓
返回后台，点击"验证配置"
  ↓
系统验证 MX/SPF 记录
  ↓
验证通过，域名状态变为"启用中"
  ↓
用户可以使用该域名创建邮箱
```

---

## 6. 非功能性需求

### 6.1 性能要求
- API 响应时间：< 200ms (P95)
- 邮件接收延迟：< 5 秒
- WebSocket 推送延迟：< 1 秒
- 页面加载时间：< 2 秒
- 支持并发：10000+ 在线用户

### 6.2 可用性要求
- 系统可用性：99.9%（年停机时间 < 8.76 小时）
- 数据持久性：99.99%
- 备份策略：每日全量备份 + 实时增量备份

### 6.3 安全要求
- ✅ 全站 HTTPS
- ✅ 密码 bcrypt 加密
- ✅ JWT Token 安全
- ✅ API 签名验证（HMAC-SHA256）
- ✅ XSS 防护（DOMPurify）
- ✅ SQL 注入防护（参数化查询）
- ✅ CSRF 防护
- ✅ 限流防护（防 DDoS）
- ✅ 审计日志

### 6.4 合规要求
- ✅ GDPR 合规（用户数据可删除）
- ✅ 隐私政策明示
- ✅ 服务条款
- ✅ 数据加密存储

### 6.5 可扩展性
- 支持水平扩展（API 服务无状态）
- Redis Cluster 支持
- PostgreSQL 主从复制
- 负载均衡支持
- Docker 容器化部署

---

## 7. 产品路线图

### V1.0（MVP - 38-40天）
- ✅ 用户注册/登录
- ✅ 邮箱管理（随机/自定义）
- ✅ 邮件接收与查看
- ✅ 多域名支持
- ✅ 实时推送（轮询 + WebSocket）
- ✅ 用户等级系统
- ✅ 管理后台（域名/用户管理）
- ✅ API Token 系统
- ✅ RESTful API (v1)

### V1.1（增强功能）
- ✅ 附件下载支持
- ✅ 邮件搜索功能
- ✅ 邮件标签/分类
- ✅ 邮件转发
- ✅ Webhook 回调

### V1.2（商业化）
- ✅ 支付集成（Stripe）
- ✅ 订阅管理
- ✅ 发票生成
- ✅ 推荐返利系统

### V2.0（高级功能）
- ✅ 自定义域名（用户绑定自己的域名）
- ✅ 邮件发送功能（SMTP 发送）
- ✅ 邮件规则过滤
- ✅ 多语言支持
- ✅ 移动端 App

---

## 8. 成功指标 (KPI)

### 8.1 用户指标
- 日活跃用户数 (DAU)
- 月活跃用户数 (MAU)
- 用户留存率（7日、30日）
- 付费转化率

### 8.2 业务指标
- 创建邮箱总数
- 接收邮件总数
- API 调用总量
- 月度经常性收入 (MRR)

### 8.3 技术指标
- API 可用性（目标 99.9%）
- 平均响应时间
- 邮件接收成功率
- 系统错误率

---

## 9. 常见问题 (FAQ)

**Q: 为什么收不到邮件？**
A: 1) 确认域名在支持列表中；2) 等待 30-60 秒；3) 检查发送方是否成功发送

**Q: 邮件会保存多久？**
A: 邮件保存 24 小时后自动删除，您也可以手动删除

**Q: 是否支持附件？**
A: V1.0 支持显示附件信息，V1.1 将支持附件下载

**Q: 如何直接访问特定邮箱？**
A: 在浏览器地址栏输入：网站地址/邮箱地址，例如：mail.example.com/test@domain.com

**Q: API 如何计费？**
A: 根据用户等级提供不同的 API 配额，超出配额可升级套餐

---

## 10. 附录

### 10.1 术语表
- **临时邮箱**：一次性邮箱，用完即弃
- **SMTP**：简单邮件传输协议，用于接收邮件
- **MIME**：多用途互联网邮件扩展，邮件格式标准
- **MX 记录**：邮件交换记录，DNS 配置
- **SPF**：发件人策略框架，防伪造
- **DMARC**：基于域的消息认证、报告和一致性
- **JWT**：JSON Web Token，身份认证令牌
- **API Key**：应用程序接口密钥
- **WebSocket**：全双工通信协议
- **PubSub**：发布订阅模式

### 10.2 参考资料
- RFC 5321 (SMTP)
- RFC 2045-2049 (MIME)
- RFC 7208 (SPF)
- OAuth 2.0 规范
- REST API 设计最佳实践

---

**文档版本**: v1.1
**最后更新**: 2025-10-12
**维护者**: 产品团队
