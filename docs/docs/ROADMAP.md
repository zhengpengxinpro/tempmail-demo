# TempMail 开发路线图

**当前版本**: v0.8.2-beta
**完成度**: 核心功能 100%
**更新时间**: 2025-10-14

---

## ✅ 已实现功能

### 核心功能（已完成）

#### 1. SMTP 邮件接收
- [x] 标准 SMTP 服务器实现（端口 25）
- [x] MIME 邮件解析（multipart 支持）
- [x] HTML 和纯文本内容提取
- [x] 中文邮件编码支持（UTF-8、GB2312）
- [x] Base64 和 Quoted-Printable 解码
- [x] 邮件附件解析和存储
- [x] 安全防护（只接收不发送，防止邮件中继）
- [x] 邮件大小限制（10MB）
- [x] 多收件人支持

#### 2. 临时邮箱管理
- [x] 创建临时邮箱（随机或自定义前缀）
- [x] 邮箱列表查询
- [x] 邮箱详情查询
- [x] 邮箱删除
- [x] 邮箱自动过期机制（默认 1 小时）
- [x] 自动清理任务（每小时执行）
- [x] 邮箱 Token 认证保护
- [x] 多域名支持
- [x] 邮箱别名系统（v0.5.0）
- [x] 别名创建/查询/更新/删除
- [x] 别名邮件路由

#### 3. 邮件管理
- [x] 邮件列表查询（支持分页）
- [x] 邮件详情查询（纯文本、HTML、原始内容）
- [x] 邮件标记已读/未读
- [x] 附件下载接口
- [x] 未读/总数统计
- [x] 邮件接收时间戳

#### 4. 用户认证系统
- [x] 用户注册
- [x] 用户登录
- [x] JWT 双令牌认证
  - 访问令牌（15 分钟）
  - 刷新令牌（7 天）
- [x] 令牌刷新机制
- [x] 密码 bcrypt 加密
- [x] 游客模式（无需登录创建邮箱）
- [x] 用户邮箱关联
- [x] 当前用户信息查询

#### 5. 角色权限系统（RBAC）
- [x] 三级角色：User、Admin、Super
- [x] 基于角色的访问控制
- [x] 用户等级系统（Free/Basic/Pro/Enterprise）
- [x] 配额系统设计
  - 最大邮箱数
  - 最大邮件数/邮箱
  - API 请求限制
  - 并发请求限制

#### 6. 管理后台 API
- [x] 用户管理
  - 用户列表（分页、搜索、过滤）
  - 用户详情查询
  - 更新用户信息（角色、等级、状态）
  - 删除用户
  - 用户配额管理
- [x] 域名管理
  - 域名列表查询
  - 添加域名
  - 删除域名
- [x] 系统统计
  - 总用户数/活跃用户数
  - 总邮箱数/活跃邮箱数
  - 总邮件数/今日邮件数
  - 按等级/角色统计用户
  - 按域名统计邮箱
  - 最近活动日志

#### 7. WebSocket 实时推送
- [x] WebSocket 服务器
- [x] 新邮件实时通知
- [x] 邮箱订阅机制
- [x] 多客户端支持
- [x] 心跳保活

#### 8. 技术架构
- [x] 分层架构设计
  - Domain 层（领域模型）
  - Service 层（业务逻辑）
  - Storage 层（存储抽象）
  - Transport 层（HTTP/SMTP）
- [x] 接口抽象（便于扩展）
- [x] 内存存储实现（开发环境）
- [x] 并发安全（RWMutex）
- [x] 结构化日志（Zap）
- [x] 配置管理（Viper + 环境变量）
- [x] 优雅关闭（信号处理）
- [x] 健康检查端点

#### 9. 安全机制
- [x] JWT 密钥长度验证（≥32 字符）
- [x] 密码强度要求
- [x] CORS 跨域配置
- [x] 邮箱 Token 认证
- [x] 请求日志追踪
- [x] 错误信息脱敏

#### 10. 用户自定义域名系统（v0.6.0）
- [x] 域名添加和管理
- [x] DNS TXT 记录验证
- [x] MX 记录配置生成
- [x] 域名状态管理（pending/verified/failed）
- [x] 两种运营模式：
  - 共享模式（免费）：任何人可创建邮箱
  - 独享模式（付费 $9.99/月）：仅所有者可创建
- [x] 邮箱创建权限控制
- [x] 域名邮箱数量统计
- [x] DNS 配置指引生成
- [x] 域名验证状态检查
- [x] 删除保护（有活跃邮箱时不可删除）

#### 11. 统一 API 响应格式系统（v0.8.0）
- [x] 标准响应结构（{code, msg, data}）
- [x] 业务状态码体系
- [x] 中文错误消息映射
- [x] 统一响应工具函数
- [x] 面向失败设计（Design for Failure）
- [x] 所有端点响应格式统一化
- [x] 兼容 API 保持旧格式不变

#### 12. 输入验证和安全增强（v0.8.1）
- [x] 邮箱地址验证模块（RFC 5322 标准）
  - 本地部分长度限制（3-64字符）
  - 域名验证（最大253字符）
  - 完整地址254字符限制
- [x] 请求体大小限制中间件
  - 基础大小限制
  - 动态路由限制
  - 基于内容类型的限制
  - 邮件专用限制（25MB）
- [x] 速率限制优化
  - 内存模式速率限制实现
  - 自动过期清理机制
  - 线程安全设计
- [x] Gin 框架生产环境优化
  - 基于配置的 GIN_MODE 设置
  - Development/Production 模式自动切换

#### 13. 兼容 API 接口（v0.8.2）
- [x] mail.ry.edu.kg 风格 API 实现
- [x] 兼容响应格式（直接返回数据）
- [x] 错误响应格式（{error: "..."}）
- [x] 完整的第三方对接支持
- [x] 100% 兼容旧系统
- [x] 详细的对接文档

### API 端点统计

**已实现 40+ 个端点**：

- 认证相关：4 个
- 邮箱管理：4 个
- 邮件管理：4 个
- 邮箱别名：5 个
- 用户域名：7 个
- 兼容 API：5 个（v0.8.2 新增）
- 管理后台：7+ 个
- WebSocket：1 个
- 健康检查：1 个

---

## 🚧 待实现功能

### 🔴 第一优先级（生产必需）

#### 1. 持久化存储 [预计 3-5 天]
**状态**: 接口已预留，需实现具体逻辑

- [ ] PostgreSQL 集成
  - [ ] 完成数据库迁移脚本（`migrations/`）
  - [ ] 实现 `storage.Store` 接口的 PostgreSQL 版本
  - [ ] 数据库连接池配置
  - [ ] 事务处理
  - [ ] 索引优化
- [ ] Redis 集成
  - [ ] 实现 Redis 缓存层
  - [ ] 邮箱信息缓存
  - [ ] 用户会话缓存
  - [ ] JWT 黑名单（登出/撤销令牌）
  - [ ] 热点数据缓存
- [ ] 缓存策略
  - [ ] Cache-Aside 模式
  - [ ] 缓存过期策略
  - [ ] 缓存击穿防护

#### 2. 限流和防滥用 [预计 2-3 天]
**状态**: 未实现

- [ ] IP 限流
  - [ ] 基于 IP 的请求速率限制
  - [ ] 滑动窗口算法
  - [ ] 黑名单管理
- [ ] 用户级别限流
  - [ ] API 调用配额检查
  - [ ] 按用户等级区分限制
  - [ ] 配额用量统计
- [ ] 邮箱创建限制
  - [ ] 实现 `MaxPerIP` 检查逻辑
  - [ ] IP 每日创建配额
  - [ ] 用户创建配额
- [ ] SMTP 防护
  - [ ] 连接频率限制
  - [ ] 发件人速率限制
  - [ ] 恶意 IP 自动封禁
- [ ] 验证码机制
  - [ ] 注册验证码
  - [ ] 登录验证码（失败次数触发）
  - [ ] 图形验证码/reCAPTCHA

#### 3. 监控和告警 [预计 3-4 天]
**状态**: 仅有基础日志

- [ ] Prometheus 指标导出
  - [ ] HTTP 请求指标（延迟、状态码）
  - [ ] SMTP 邮件接收指标
  - [ ] 数据库连接池指标
  - [ ] 缓存命中率
  - [ ] 业务指标（创建邮箱数、收到邮件数）
- [ ] Grafana 仪表盘
  - [ ] 系统监控看板
  - [ ] 业务指标看板
  - [ ] 告警规则配置
- [ ] 日志聚合
  - [ ] 结构化日志输出（JSON）
  - [ ] ELK Stack / Loki 集成
  - [ ] 日志分级存储
- [ ] 告警系统
  - [ ] AlertManager 集成
  - [ ] 邮件/Webhook 告警
  - [ ] 告警规则配置

#### 4. 邮件内容安全 [预计 4-5 天]
**状态**: 未实现

- [ ] 病毒扫描
  - [ ] ClamAV 集成
  - [ ] 附件扫描
  - [ ] 隔离危险邮件
- [ ] 垃圾邮件过滤
  - [ ] SpamAssassin 集成
  - [ ] 贝叶斯过滤器
  - [ ] 黑名单/白名单
- [ ] 钓鱼邮件检测
  - [ ] URL 检测
  - [ ] 域名信誉检查
  - [ ] 品牌仿冒检测
- [ ] 内容过滤
  - [ ] 恶意链接检测
  - [ ] 附件类型限制（.exe、.bat）
  - [ ] 敏感内容过滤
  - [ ] XSS 过滤

#### 5. 数据备份和恢复 [预计 2-3 天]
**状态**: 未实现

- [ ] 自动备份
  - [ ] 每日全量备份
  - [ ] 每小时增量备份
  - [ ] 备份保留策略
- [ ] 备份验证
  - [ ] 定期恢复测试
  - [ ] 备份完整性检查
- [ ] 灾难恢复
  - [ ] 恢复脚本
  - [ ] RTO/RPO 目标
  - [ ] 异地备份

**第一优先级总时间**: 约 2-3 周

---

### 🟡 第二优先级（生产优化）

#### 6. 性能优化 [预计 3-5 天]
- [ ] 数据库优化
  - [ ] 索引分析和优化
  - [ ] 慢查询分析
  - [ ] 查询语句优化
  - [ ] 读写分离
- [ ] 缓存优化
  - [ ] 缓存预热
  - [ ] 缓存更新策略
  - [ ] 缓存雪崩防护
- [ ] 消息队列
  - [ ] RabbitMQ / Kafka 集成
  - [ ] 异步处理邮件
  - [ ] 削峰填谷
- [ ] 并发优化
  - [ ] Goroutine 池
  - [ ] 连接复用
  - [ ] 批量操作优化

#### 7. 安全增强 [预计 3-4 天]
- [ ] SMTP TLS/SSL
  - [ ] STARTTLS 支持
  - [ ] SSL 证书配置
- [ ] HTTPS 强制
  - [ ] Let's Encrypt 自动证书
  - [ ] HSTS 头
- [ ] API 安全
  - [ ] 请求签名验证
  - [ ] API Key 管理
  - [ ] IP 白名单
- [ ] 数据加密
  - [ ] 敏感字段加密存储
  - [ ] 传输加密
- [ ] 安全审计
  - [ ] 定期漏洞扫描
  - [ ] 依赖安全检查
  - [ ] 渗透测试

#### 8. 高可用架构 [预计 5-7 天]
- [ ] 负载均衡
  - [ ] Nginx / HAProxy 配置
  - [ ] 健康检查
  - [ ] 会话保持
- [ ] 服务多实例
  - [ ] 无状态设计
  - [ ] 会话共享（Redis）
  - [ ] 配置同步
- [ ] 数据库高可用
  - [ ] PostgreSQL 主从复制
  - [ ] 自动故障切换
  - [ ] 读写分离
- [ ] Redis 高可用
  - [ ] Redis Sentinel
  - [ ] Redis Cluster
  - [ ] 自动故障切换

#### 9. 邮件管理增强 [预计 3-4 天]
- [ ] 全文搜索
  - [ ] Elasticsearch 集成
  - [ ] 邮件内容索引
  - [ ] 高级搜索语法
- [ ] 邮件操作
  - [ ] 邮件标签/分类
  - [ ] 批量操作
  - [ ] 邮件导出（.eml）
  - [ ] 邮件转发（可选）
- [ ] 邮件过滤
  - [ ] 自定义过滤规则
  - [ ] 关键词过滤
  - [ ] 发件人过滤

#### 10. 用户体验优化 [预计 2-3 天]
- [ ] 通知系统
  - [ ] 邮件通知
  - [ ] Webhook 回调
  - [ ] 推送通知（可选）
- [ ] 邮箱功能
  - [ ] 邮箱续期
  - [ ] 邮箱收藏/置顶
  - [ ] 自定义过期时间
- [ ] 国际化
  - [ ] 多语言支持（i18n）
  - [ ] 时区处理

**第二优先级总时间**: 约 3-4 周

---

### 🟢 第三优先级（商业化运营）

#### 11. 商业化功能 [预计 5-7 天]
- [ ] 订阅系统
  - [ ] 订阅计划管理
  - [ ] 配额自动调整
  - [ ] 订阅状态检查
- [ ] 支付集成
  - [ ] Stripe / PayPal
  - [ ] 微信支付 / 支付宝
  - [ ] 发票生成
- [ ] 计费系统
  - [ ] 使用量统计
  - [ ] 计费规则引擎
  - [ ] 账单管理

#### 12. API 增强 [预计 3-4 天]
- [ ] API 文档
  - [ ] Swagger UI
  - [ ] 交互式文档
  - [ ] 代码示例
- [ ] API 管理
  - [ ] API Key 管理
  - [ ] 版本控制（/v2）
  - [ ] 弃用通知
- [ ] 开发者工具
  - [ ] SDK（Go/Python/JS）
  - [ ] CLI 工具
  - [ ] Postman Collection

#### 13. 企业功能 [预计 7-10 天]
- [ ] 团队管理
  - [ ] 团队创建/管理
  - [ ] 成员邀请
  - [ ] 权限分配
- [ ] 审计日志
  - [ ] 完整操作记录
  - [ ] 日志查询
  - [ ] 导出审计报告
- [ ] 白标定制
  - [ ] 自定义品牌
  - [ ] 自定义域名
  - [ ] 自定义邮件模板

#### 14. 合规性 [预计 5-7 天]
- [ ] GDPR 合规
  - [ ] 数据导出
  - [ ] 数据删除请求
  - [ ] 隐私政策管理
- [ ] 法律合规
  - [ ] 服务条款管理
  - [ ] 数据保留策略
  - [ ] 用户同意管理

#### 15. 运营工具 [预计 7-10 天]
- [ ] 管理后台前端
  - [ ] 用户管理界面
  - [ ] 数据统计看板
  - [ ] 系统配置界面
- [ ] 数据分析
  - [ ] 用户行为分析
  - [ ] 留存率分析
  - [ ] 转化漏斗
- [ ] 运营功能
  - [ ] 公告管理
  - [ ] 用户反馈系统
  - [ ] 人工审核工具

**第三优先级总时间**: 约 5-6 周

---

### 🔵 第四优先级（长期规划）

#### 16. 高级功能
- [ ] AI 功能
  - [ ] 智能分类
  - [ ] 邮件摘要
  - [ ] 自动回复建议
- [ ] 数据分析
  - [ ] 用户画像
  - [ ] 邮件流量分析
  - [ ] 异常检测
- [ ] 扩展性
  - [ ] 插件系统
  - [ ] 自定义扩展
  - [ ] Webhook 事件系统

#### 17. DevOps 优化
- [ ] 容器化
  - [ ] Docker 镜像优化
  - [ ] 多阶段构建
- [ ] Kubernetes
  - [ ] Helm Charts
  - [ ] HPA 自动伸缩
  - [ ] StatefulSet 配置
- [ ] CI/CD
  - [ ] 自动化测试覆盖
  - [ ] 蓝绿部署
  - [ ] 金丝雀发布
- [ ] 测试
  - [ ] 单元测试（80%+ 覆盖率）
  - [ ] 集成测试
  - [ ] E2E 测试
  - [ ] 性能测试

---

## 📊 开发计划

### Phase 1: MVP 上线（2-3 周）
**目标**: 可运营的最小可行产品

- 持久化存储（PostgreSQL + Redis）
- 基础限流和防护
- 监控告警系统
- 邮件内容安全
- 数据备份方案

**完成标准**:
- ✅ 数据不丢失
- ✅ 可监控运行状态
- ✅ 基本安全防护
- ✅ 可恢复数据

### Phase 2: 生产级稳定性（3-4 周）
**目标**: 稳定可靠的生产系统

- 性能优化
- 安全增强
- 高可用架构
- 邮件管理增强
- 用户体验优化

**完成标准**:
- ✅ 99.9% 可用性
- ✅ 支持 1000+ 并发
- ✅ 平均响应时间 < 100ms
- ✅ 完整的灾备方案

### Phase 3: 商业化运营（4-6 周）
**目标**: 支持商业化运营

- 订阅和支付系统
- API 增强和文档
- 企业功能
- 合规性功能
- 运营工具

**完成标准**:
- ✅ 支持多种订阅计划
- ✅ 完整的支付流程
- ✅ 符合法律合规要求
- ✅ 完善的运营工具

### Phase 4: 规模化增长（持续）
**目标**: 支持大规模用户增长

- AI 功能
- 高级数据分析
- 完整的 DevOps 流程
- 插件生态

---

## 🎯 里程碑

- **v0.8.2** (当前) - 兼容API完全兼容 mail.ry.edu.kg
- **v0.8.1** - 输入验证和安全增强
- **v0.8.0** - 统一API响应格式（重大更新）
- **v0.7.0** - API Key管理和技术栈优化
- **v0.6.0** - 用户自定义域名系统（商业化基础）
- **v1.0.0** (2-3 周后) - MVP 上线，持久化存储
- **v1.5.0** (6-7 周后) - 生产级稳定性
- **v2.0.0** (10-13 周后) - 商业化运营
- **v3.0.0** (持续迭代) - 规模化增长

---

## 📝 技术债务

当前已知的技术债务：

1. **内存存储** - 服务重启数据丢失
2. **无限流保护** - 容易被恶意攻击
3. **无监控** - 无法及时发现问题
4. **日志简单** - 排查问题困难
5. **单实例部署** - 无高可用
6. **无自动化测试** - 回归风险高
7. **配额检查未实现** - MaxPerIP 等逻辑未生效
8. **邮件内容不过滤** - 安全风险

---

## 💡 建议

### 快速上线运营
优先实现 **Phase 1**（2-3 周），包含：
1. PostgreSQL + Redis 持久化
2. 基础限流防护
3. Prometheus 监控
4. 邮件安全过滤
5. 自动备份

### 稳定运营
实现 **Phase 2**（再 3-4 周），重点：
1. 高可用架构
2. 性能优化
3. 安全加固

### 商业化
实现 **Phase 3**（再 4-6 周），包含：
1. 订阅和支付
2. 完整的管理后台
3. 合规性功能

---

**注意**: 以上时间估算基于单人全职开发，实际时间可能因团队规模和优先级调整而变化。
